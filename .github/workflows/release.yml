name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            qt_arch: gcc_64
          - os: macos-13
            qt_arch: clang_64
          - os: windows-latest
            qt_arch: win64_msvc2019_64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          cached: true
          archives: qttools
          version: 5.15.2
          arch: ${{ matrix.qt_arch }}

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        shell: bash

      - name: Build
        run: cmake --build build --config Release
        shell: bash

      - name: Install Linux packaging dependencies
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y patchelf desktop-file-utils
        shell: bash

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          set -euo pipefail
          mkdir -p dist
          EXE_PATH="build/Release/FullScreen-Pencil-Draw.exe"
          if [[ ! -f "$EXE_PATH" ]]; then
            EXE_PATH="build/FullScreen-Pencil-Draw.exe"
          fi
          cp "$EXE_PATH" dist/FullScreen-Pencil-Draw.exe
          windeployqt --release --compiler-runtime dist/FullScreen-Pencil-Draw.exe
          powershell -Command "Compress-Archive -Path dist\\* -DestinationPath FullScreen-Pencil-Draw-${{ runner.os }}.zip"
          echo "ASSET=FullScreen-Pencil-Draw-${RUNNER_OS}.zip" >> $GITHUB_ENV
        shell: bash

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          APP_PATH="build/FullScreen-Pencil-Draw.app"
          if [[ ! -d "$APP_PATH" ]]; then
            APP_PATH="build/Release/FullScreen-Pencil-Draw.app"
          fi
          macdeployqt "$APP_PATH" -verbose=1 -always-overwrite
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "FullScreen-Pencil-Draw-${RUNNER_OS}.zip"
          echo "ASSET=FullScreen-Pencil-Draw-${RUNNER_OS}.zip" >> $GITHUB_ENV
        shell: bash

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          mkdir -p dist/AppDir/usr/bin
          cp build/FullScreen-Pencil-Draw dist/AppDir/usr/bin/
          cat > dist/AppDir/FullScreen-Pencil-Draw.desktop <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=FullScreen Pencil Draw
          Exec=FullScreen-Pencil-Draw
          Icon=FullScreen-Pencil-Draw
          Categories=Graphics;
          EOF
          printf '%s' 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=' | base64 -d > dist/AppDir/FullScreen-Pencil-Draw.png
          curl -L -o dist/linuxdeployqt.AppImage https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x dist/linuxdeployqt.AppImage
          QMAKE_BIN="$(command -v qmake || command -v qmake6)"
          if [[ -z "${QMAKE_BIN}" ]]; then
            echo "qmake not found in PATH"
            exit 1
          fi
          cd dist
          export APPIMAGE_EXTRACT_AND_RUN=1
          ./linuxdeployqt.AppImage AppDir/FullScreen-Pencil-Draw.desktop -qmake="$QMAKE_BIN" -appimage -verbose=2
          APPIMAGE_NAME="$(ls -1 *.AppImage | grep -v '^linuxdeployqt' | head -n 1)"
          mv "$APPIMAGE_NAME" "FullScreen-Pencil-Draw-${RUNNER_OS}.AppImage"
          echo "ASSET=dist/FullScreen-Pencil-Draw-${RUNNER_OS}.AppImage" >> $GITHUB_ENV
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FullScreen-Pencil-Draw-${{ runner.os }}
          path: ${{ env.ASSET }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
